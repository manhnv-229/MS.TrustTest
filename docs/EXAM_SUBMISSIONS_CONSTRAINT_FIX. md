# Fix Exam Submissions Constraint Issue

## ğŸš¨ Váº¥n Ä‘á» (Issue)

Khi student cá»‘ gáº¯ng lÃ m bÃ i thi láº§n thá»© 2 (attempt thá»© 2), há»‡ thá»‘ng bÃ¡o lá»—i:

```
SQL Error: 1062, SQLState: 23000
Duplicate entry '5-5' for key 'exam_submissions.uk_exam_student'
```

**Root Cause:** Constraint `uk_exam_student` trong database Ä‘Æ°á»£c thiáº¿t káº¿ sai - chá»‰ cho phÃ©p 1 submission duy nháº¥t per `(exam_id, student_id)`, nhÆ°ng theo business requirements, student cÃ³ thá»ƒ lÃ m nhiá»u attempts.

## ğŸ” PhÃ¢n tÃ­ch (Analysis)

### Database Constraint Issue
- **Constraint hiá»‡n táº¡i:** `uk_exam_student` trÃªn `(exam_id, student_id)`
- **Váº¥n Ä‘á»:** NgÄƒn student lÃ m attempt thá»© 2, 3... 
- **Constraint Ä‘Ãºng:** Should be `uk_exam_student_attempt` trÃªn `(exam_id, student_id, attempt_number)`

### Business Logic Requirements
Theo `docs/START_EXAM_SCENARIO.md`:
- **Scenario 1:** Student lÃ m láº§n Ä‘áº§u â†’ táº¡o submission má»›i (attempt=1)
- **Scenario 2:** Student tiáº¿p tá»¥c bÃ i dá»Ÿ â†’ return existing active submission  
- **Scenario 3:** Student lÃ m láº§n thá»© 2 â†’ táº¡o submission má»›i (attempt=2)

## âš¡ Giáº£i phÃ¡p (Solution)

### 1. Database Migration (Recommended)
```sql
-- Drop constraint cÅ© (sai thiáº¿t káº¿)
ALTER TABLE exam_submissions DROP INDEX uk_exam_student;

-- Táº¡o constraint má»›i Ä‘Ãºng thiáº¿t káº¿
ALTER TABLE exam_submissions 
ADD CONSTRAINT uk_exam_student_attempt 
UNIQUE KEY (exam_id, student_id, attempt_number);
```

**File:** `database/fix-exam-submissions-constraint.sql`

### 2.  Application Logic Fix (Workaround)
Cáº£i thiá»‡n logic trong `ExamTakingService. startExam()` Ä‘á»ƒ handle constraint violation gracefully:

#### Improvements:
1. **Enhanced Error Handling:**
   - Catch `DataIntegrityViolationException` 
   - Detect UK constraint violation
   - Implement intelligent retry mechanism

2. **Smart Retry Logic:**
   - TÃ¬m existing submissions
   - Náº¿u latest submission Ä‘Ã£ SUBMITTED/GRADED â†’ táº¡o attempt má»›i vá»›i incremented attempt_number
   - Náº¿u cÃ³ active submission â†’ return existing

3. **Detailed Logging:**
   - Log constraint violations 
   - Track retry attempts
   - Monitor success/failure patterns

#### Code Changes:
**File:** `backend/src/main/java/com/mstrust/exam/service/ExamTakingService.java`

**Key Methods Enhanced:**
- `startExam()` - Added comprehensive constraint violation handling
- `updateSubmissionTracking()` - Improved optimistic locking retry

## ğŸ§ª Testing

### Test Cases
1. **Normal Flow:** Student lÃ m láº§n Ä‘áº§u â†’ Success
2. **Continue Flow:** Student tiáº¿p tá»¥c bÃ i dá»Ÿ â†’ Return existing
3. **Retry Flow:** Student lÃ m láº§n 2 â†’ Handle constraint, create attempt 2
4. **Edge Cases:** Multiple concurrent requests, constraint conflicts

### Test File
`test-start-exam-fix.http` - Thunder Client test cases

### Expected Results
- âœ… KhÃ´ng cÃ²n lá»—i "Duplicate entry"
- âœ… Student cÃ³ thá»ƒ lÃ m multiple attempts
- âœ… System handles constraints gracefully
- âœ… Proper attempt_number increment

## ğŸ“Š Verification

### Database Check
```sql
-- Kiá»ƒm tra submissions cá»§a student 5 cho exam 5
SELECT exam_id, student_id, attempt_number, status, started_at 
FROM exam_submissions 
WHERE exam_id = 5 AND student_id = 5
ORDER BY attempt_number;
```

**Expected:** CÃ³ thá»ƒ tháº¥y nhiá»u attempts (1, 2, 3.. .) thay vÃ¬ chá»‰ 1

### Log Monitoring
Monitor application logs cho:
- `[StartExam] UK constraint violation` warnings
- `[StartExam] Successfully created submission` success messages  
- Retry attempt tracking

## ğŸ”„ Rollback Plan

Náº¿u cÃ³ váº¥n Ä‘á», rollback báº±ng cÃ¡ch:

1. **Restore constraint cÅ©:**
```sql
ALTER TABLE exam_submissions DROP INDEX uk_exam_student_attempt;
ALTER TABLE exam_submissions ADD CONSTRAINT uk_exam_student UNIQUE KEY (exam_id, student_id);
```

2. **Revert code changes** trong ExamTakingService

## ğŸ“ Notes

- **Temporary Solution:** Application logic fix is a workaround cho Ä‘áº¿n khi database constraint Ä‘Æ°á»£c sá»­a
- **Performance Impact:** Minimal - chá»‰ affect khi cÃ³ constraint violation
- **Data Integrity:** Maintained through attempt_number logic
- **Future Improvement:** Proper constraint `uk_exam_student_attempt` should be applied

## ğŸ·ï¸ Tags
`bug-fix`, `database-constraint`, `exam-taking`, `multiple-attempts`, `constraint-violation`

---
**Author:** K24DTCN210-NVMANH  
**Date:** 03/12/2025 13:29  
**Status:** âœ… RESOLVED
